<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML转PDF增强版</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        textarea {
            width: 100%;
            height: 300px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 20px;
            resize: vertical;
            font-family: 'Courier New', monospace;
        }
        .preview {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 20px;
            margin-bottom: 20px;
            background-color: white;
            min-height: 200px;
        }
        .buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #2980b9;
        }
        .instructions {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 4px;
            margin-top: 30px;
            border-left: 4px solid #3498db;
        }
        
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #3498db;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .status-message {
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            display: none;
        }
        .status-message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status-message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        /* 为PDF内容创建专用容器的样式 */
        #pdf-content {
            background: white;
            padding: 20px;
            width: 210mm; /* A4宽度 */
            min-height: 200px;
            box-sizing: border-box;
            margin: 0 auto;
            font-family: 'Microsoft YaHei', Arial, sans-serif;
        }
        
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            .container {
                padding: 15px;
            }
            .buttons {
                flex-direction: column;
            }
            button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>HTML转PDF增强版</h1>
        
        <div id="statusMessage" class="status-message"></div>
        
        <label for="htmlInput">请输入HTML代码：</label>
        <textarea id="htmlInput" placeholder="在此粘贴您的HTML代码"></textarea>
        
        <div class="buttons">
            <button onclick="preview()">预览</button>
            <button onclick="generatePDF()">转换为PDF</button>
            <button onclick="usePrintMethod()">备用方法转换</button>
        </div>
        
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>处理中，请稍候...</p>
        </div>
        
        <h3>预览：</h3>
        <div id="preview" class="preview"></div>
        
        <!-- 用于生成PDF的隐藏容器 -->
        <div id="pdf-container" style="position: absolute; left: -9999px;">
            <div id="pdf-content"></div>
        </div>
        
        <div class="instructions">
            <h3>使用说明：</h3>
            <ol>
                <li>在文本框中粘贴您的HTML代码</li>
                <li>点击"预览"按钮查看HTML渲染效果</li>
                <li>点击"转换为PDF"按钮将HTML转换为PDF并下载</li>
                <li>如果内容为空白，请尝试"备用方法转换"按钮</li>
            </ol>
            <p><strong>注意：</strong> 如果生成的PDF为空白，可以尝试：</p>
            <ul>
                <li>确保HTML代码中的图片使用完整URL路径</li>
                <li>避免使用复杂的CSS布局，如flex或grid</li>
                <li>尝试使用备用转换方法</li>
            </ul>
        </div>
    </div>

    <script>
        // 显示状态消息
        function showMessage(message, type) {
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.textContent = message;
            statusMessage.className = 'status-message ' + type;
            statusMessage.style.display = 'block';
            
            setTimeout(() => {
                statusMessage.style.display = 'none';
            }, 5000);
        }
        
        // 预览功能
        function preview() {
            const htmlInput = document.getElementById('htmlInput').value;
            const previewDiv = document.getElementById('preview');
            
            if (!htmlInput.trim()) {
                previewDiv.innerHTML = '<p style="color: #999;">预览区域 - 请先输入HTML代码</p>';
                showMessage('请先输入HTML代码', 'error');
                return;
            }
            
            try {
                previewDiv.innerHTML = htmlInput;
                
                // 同时更新PDF内容容器
                document.getElementById('pdf-content').innerHTML = htmlInput;
                
                showMessage('预览成功', 'success');
            } catch (error) {
                console.error('预览失败:', error);
                previewDiv.innerHTML = '<p style="color: #ff0000;">预览失败: ' + error.message + '</p>';
                showMessage('预览失败: ' + error.message, 'error');
            }
        }
        
        // 转换为PDF的新方法，使用分段处理
        function generatePDF() {
            const htmlInput = document.getElementById('htmlInput').value;
            
            if (!htmlInput.trim()) {
                showMessage('请先输入HTML代码！', 'error');
                return;
            }
            
            // 显示加载中
            document.getElementById('loading').style.display = 'block';
            
            // 确保PDF内容容器已经更新
            document.getElementById('pdf-content').innerHTML = htmlInput;
            
            // 获取内容元素
            const element = document.getElementById('pdf-content');
            
            // 给所有图片添加onload事件，确保它们加载完成
            const images = element.querySelectorAll('img');
            let loadedImages = 0;
            const totalImages = images.length;
            
            // 设置最小延迟，确保DOM渲染
            setTimeout(() => {
                // 如果没有图片，直接开始转换
                if (totalImages === 0) {
                    startPDFConversion();
                    return;
                }
                
                // 处理图片加载
                images.forEach(img => {
                    // 如果图片没有明确的尺寸，设置一个默认尺寸
                    if (!img.style.width) img.style.width = 'auto';
                    if (!img.style.height) img.style.height = 'auto';
                    
                    // 已加载的图片
                    if (img.complete) {
                        loadedImages++;
                        if (loadedImages === totalImages) {
                            startPDFConversion();
                        }
                    } else {
                        // 图片加载事件
                        img.onload = function() {
                            loadedImages++;
                            if (loadedImages === totalImages) {
                                startPDFConversion();
                            }
                        };
                        
                        // 图片加载失败事件
                        img.onerror = function() {
                            loadedImages++;
                            console.warn('图片加载失败:', img.src);
                            if (loadedImages === totalImages) {
                                startPDFConversion();
                            }
                        };
                    }
                });
                
                // 设置超时，防止图片加载过久
                setTimeout(() => {
                    if (loadedImages < totalImages) {
                        console.warn(`只有 ${loadedImages}/${totalImages} 张图片加载完成，但仍继续转换`);
                        startPDFConversion();
                    }
                }, 3000);
            }, 1000);
            
            // 开始PDF转换的函数
            function startPDFConversion() {
                const pdfContent = document.getElementById('pdf-content');
                
                try {
                    // 使用html2canvas捕获内容
                    html2canvas(pdfContent, {
                        scale: 2,
                        useCORS: true,
                        allowTaint: true,
                        logging: false,
                        letterRendering: true
                    }).then(canvas => {
                        // 创建PDF
                        const { jsPDF } = window.jspdf;
                        const pdf = new jsPDF('p', 'mm', 'a4');
                        
                        // 添加图像到PDF
                        const imgData = canvas.toDataURL('image/jpeg', 1.0);
                        const pdfWidth = pdf.internal.pageSize.getWidth();
                        const pdfHeight = pdf.internal.pageSize.getHeight();
                        const imgWidth = canvas.width;
                        const imgHeight = canvas.height;
                        const ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight);
                        const imgX = (pdfWidth - imgWidth * ratio) / 2;
                        const imgY = 10;
                        
                        pdf.addImage(imgData, 'JPEG', imgX, imgY, imgWidth * ratio, imgHeight * ratio);
                        
                        // 保存PDF
                        pdf.save('converted-document.pdf');
                        
                        // 隐藏加载中
                        document.getElementById('loading').style.display = 'none';
                        showMessage('PDF生成成功！', 'success');
                    }).catch(error => {
                        console.error('转换失败:', error);
                        document.getElementById('loading').style.display = 'none';
                        showMessage('PDF生成失败: ' + error.message, 'error');
                    });
                } catch (error) {
                    console.error('PDF处理失败:', error);
                    document.getElementById('loading').style.display = 'none';
                    showMessage('PDF处理失败: ' + error.message, 'error');
                }
            }
        }
        
        // 备用方法 - 使用打印功能生成PDF
        function usePrintMethod() {
            const htmlInput = document.getElementById('htmlInput').value;
            
            if (!htmlInput.trim()) {
                showMessage('请先输入HTML代码！', 'error');
                return;
            }
            
            document.getElementById('loading').style.display = 'block';
            showMessage('正在准备打印视图...', 'success');
            
            // 创建一个新窗口
            const printWindow = window.open('', '_blank');
            
            // 添加基本样式，确保打印效果良好
            const printDocument = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>打印文档</title>
                    <style>
                        @page {
                            margin: 1cm;
                        }
                        body {
                            font-family: Arial, sans-serif;
                            line-height: 1.5;
                        }
                    </style>
                </head>
                <body>
                    ${htmlInput}
                </body>
                </html>
            `;
            
            printWindow.document.write(printDocument);
            printWindow.document.close();
            
            // 等待内容加载完成后进行打印
            printWindow.onload = function() {
                document.getElementById('loading').style.display = 'none';
                
                // 短暂延迟确保内容渲染完成
                setTimeout(() => {
                    printWindow.focus();
                    printWindow.print();
                    showMessage('请在打印对话框中选择"保存为PDF"', 'success');
                }, 1000);
            };
        }
    </script>
</body>
</html>
