<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML转PDF工具</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        textarea {
            width: 100%;
            height: 300px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 20px;
            resize: vertical;
            font-family: 'Courier New', monospace;
        }
        .preview {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 20px;
            margin-bottom: 20px;
            background-color: white;
            min-height: 200px;
        }
        .buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #2980b9;
        }
        .instructions {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 4px;
            margin-top: 30px;
            border-left: 4px solid #3498db;
        }
        
        /* 加载动画 */
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #3498db;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 状态消息 */
        .status-message {
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            display: none;
        }
        .status-message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status-message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            .container {
                padding: 15px;
            }
            .buttons {
                flex-direction: column;
            }
            button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>HTML转PDF工具</h1>
        
        <!-- 状态消息 -->
        <div id="statusMessage" class="status-message"></div>
        
        <label for="htmlInput">请输入HTML代码：</label>
        <textarea id="htmlInput" placeholder="在此粘贴您的HTML代码"></textarea>
        
        <div class="buttons">
            <button onclick="preview()">预览</button>
            <button onclick="convert()">转换为PDF</button>
        </div>
        
        <!-- 加载动画 -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>处理中，请稍候...</p>
        </div>
        
        <h3>预览：</h3>
        <div id="preview" class="preview"></div>
        
        <div class="instructions">
            <h3>使用说明：</h3>
            <ol>
                <li>在文本框中粘贴您的HTML代码</li>
                <li>点击"预览"按钮查看HTML渲染效果</li>
                <li>点击"转换为PDF"按钮将HTML转换为PDF并下载</li>
            </ol>
            <p><strong>注意：</strong> 本工具在本地运行，您的HTML内容不会上传到任何服务器。</p>
        </div>
    </div>

    <script>
        // 显示状态消息
        function showMessage(message, type) {
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.textContent = message;
            statusMessage.className = 'status-message ' + type;
            statusMessage.style.display = 'block';
            
            // 5秒后自动隐藏
            setTimeout(() => {
                statusMessage.style.display = 'none';
            }, 5000);
        }
        
        // 预览功能
        function preview() {
            const htmlInput = document.getElementById('htmlInput').value;
            const previewDiv = document.getElementById('preview');
            
            if (!htmlInput.trim()) {
                previewDiv.innerHTML = '<p style="color: #999;">预览区域 - 请先输入HTML代码</p>';
                showMessage('请先输入HTML代码', 'error');
                return;
            }
            
            try {
                previewDiv.innerHTML = htmlInput;
                showMessage('预览成功', 'success');
            } catch (error) {
                console.error('预览失败:', error);
                previewDiv.innerHTML = '<p style="color: #ff0000;">预览失败: ' + error.message + '</p>';
                showMessage('预览失败: ' + error.message, 'error');
            }
        }
        
        // 转换为PDF功能
        function convert() {
            const htmlInput = document.getElementById('htmlInput').value;
            
            if (!htmlInput.trim()) {
                showMessage('请先输入HTML代码！', 'error');
                return;
            }
            
            // 显示加载中动画
            document.getElementById('loading').style.display = 'block';
            
            try {
                // 创建一个临时容器
                const container = document.createElement('div');
                container.innerHTML = htmlInput;
                
                // 强制设置容器的大小，避免0宽高问题
                container.style.width = '210mm';  // A4纸宽度
                container.style.padding = '10mm';
                container.style.visibility = 'hidden';
                container.style.position = 'absolute';
                container.style.left = '-9999px';
                container.style.top = '0';
                
                // 将容器添加到文档中
                document.body.appendChild(container);
                
                // 给页面中的所有图片添加加载完成事件
                const images = container.querySelectorAll('img');
                let imagesLoaded = 0;
                const totalImages = images.length;
                
                // 如果没有图片，直接转换
                if (totalImages === 0) {
                    generatePDF(container);
                    return;
                }
                
                // 为所有图片添加加载事件
                images.forEach(img => {
                    // 确保图片有宽高
                    if (!img.style.width) img.style.width = 'auto';
                    if (!img.style.height) img.style.height = 'auto';
                    
                    // 已加载的图片
                    if (img.complete) {
                        imagesLoaded++;
                        if (imagesLoaded === totalImages) {
                            generatePDF(container);
                        }
                    } else {
                        // 图片加载事件
                        img.onload = function() {
                            imagesLoaded++;
                            if (imagesLoaded === totalImages) {
                                generatePDF(container);
                            }
                        };
                        
                        // 图片加载失败事件
                        img.onerror = function() {
                            imagesLoaded++;
                            if (imagesLoaded === totalImages) {
                                generatePDF(container);
                            }
                        };
                    }
                });
                
                // 设置超时，防止图片加载太慢
                setTimeout(() => {
                    if (imagesLoaded < totalImages) {
                        showMessage('某些图片加载超时，生成的PDF可能不完整', 'error');
                        generatePDF(container);
                    }
                }, 5000);
                
            } catch (error) {
                console.error('准备转换失败:', error);
                document.getElementById('loading').style.display = 'none';
                showMessage('转换准备失败: ' + error.message, 'error');
            }
        }
        
        // 生成PDF的函数
        function generatePDF(element) {
            // 确保所有的canvas元素都有宽高
            const canvases = element.querySelectorAll('canvas');
            canvases.forEach(canvas => {
                if (canvas.width === 0) canvas.width = 300;
                if (canvas.height === 0) canvas.height = 150;
            });
            
            // 等待一段时间，确保DOM完全渲染
            setTimeout(() => {
                const options = {
                    margin: 10,
                    filename: 'converted-document.pdf',
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { 
                        scale: 2,
                        useCORS: true,
                        logging: false,
                        allowTaint: true
                    },
                    jsPDF: { 
                        unit: 'mm', 
                        format: 'a4', 
                        orientation: 'portrait'
                    }
                };
                
                html2pdf().from(element).set(options).save()
                    .then(() => {
                        // 移除临时元素
                        document.body.removeChild(element);
                        document.getElementById('loading').style.display = 'none';
                        showMessage('PDF生成成功！', 'success');
                    })
                    .catch(error => {
                        console.error('PDF生成失败:', error);
                        document.body.removeChild(element);
                        document.getElementById('loading').style.display = 'none';
                        showMessage('PDF生成失败: ' + error.message, 'error');
                        
                        // 如果还是失败，提供备用方案
                        if (confirm('转换失败。是否尝试使用打印功能导出为PDF？')) {
                            printToPDF();
                        }
                    });
            }, 500);
        }
        
        // 备用的打印为PDF方法
        function printToPDF() {
            const htmlInput = document.getElementById('htmlInput').value;
            
            // 创建一个新窗口用于打印
            const printWindow = window.open('', '_blank');
            printWindow.document.write(htmlInput);
            printWindow.document.close();
            
            // 等待页面加载完成后打印
            printWindow.onload = function() {
                printWindow.focus();
                setTimeout(() => {
                    printWindow.print();
                    showMessage('请使用浏览器的"打印为PDF"功能完成转换', 'success');
                }, 500);
            };
        }
    </script>
</body>
</html>
